<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECHVIDYA 2K25 - CHANAKYOTSAV BROCHURE</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js" as="script">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" as="style">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://pub-01b86a07b6904467a8a45ae0ec6c8c9e.r2.dev/favicon.ico">
    
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap');

        html, body {
            margin: 0;
            padding: 0;
            background-color: #0a0a0a;
            font-family: 'Oswald', sans-serif;
            color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        html::-webkit-scrollbar, body::-webkit-scrollbar {
            display: none;
        }

        header {
            padding: 2.5rem 2rem;
            border-bottom: 1px solid #222;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 0;
        }
        
        .pdf-container {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .pdf-container::-webkit-scrollbar {
            display: none;
        }

        #pdf-viewer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            box-sizing: border-box;
        }

        .page-wrapper {
            width: 90%;
            max-width: 800px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            min-height: 400px;
            background-color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .page-wrapper canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        .loading-placeholder {
            color: #666;
            font-size: 14px;
        }

        .zoom-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        .performance-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .performance-indicator.show {
            opacity: 1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <header>
        <h1>TECHVIDYA 2K25 - CHANAKYOTSAV BROCHURE</h1>
    </header>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div>Loading PDF...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div id="loading-status">Initializing...</div>
    </div>

    <div class="pdf-container" id="pdf-container">
        <div id="pdf-viewer"></div>
    </div>

    <div class="zoom-hint">ðŸ’¡ Use pinch-to-zoom or Ctrl+scroll for QR codes</div>
    <div class="performance-indicator" id="performance-indicator"></div>

    <script>
        // Register Service Worker for caching (non-blocking)
        if ('serviceWorker' in navigator) {
            // Delay service worker registration to not block initial load
            setTimeout(() => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => console.log('Service Worker registration failed:', error));
            }, 2000);
        }

        // Performance monitoring
        const perfIndicator = document.getElementById('performance-indicator');
        const loadingOverlay = document.getElementById('loading-overlay');
        const progressFill = document.getElementById('progress-fill');
        const loadingStatus = document.getElementById('loading-status');
        
        let startTime = performance.now();
        let pagesLoaded = 0;
        let totalPages = 0;

        function updatePerformance(message) {
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
            perfIndicator.textContent = `${message} (${elapsed}s)`;
            perfIndicator.classList.add('show');
            setTimeout(() => perfIndicator.classList.remove('show'), 3000);
        }

        function updateProgress(loaded, total, status) {
            const percentage = (loaded / total) * 100;
            progressFill.style.width = percentage + '%';
            loadingStatus.textContent = status || `Loading... ${loaded}/${total}`;
        }

        function hideLoadingOverlay() {
            loadingOverlay.classList.add('hidden');
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 500);
        }

        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const url = 'https://pub-01b86a07b6904467a8a45ae0ec6c8c9e.r2.dev/TechVidya-Brochure.pdf';
        const container = document.getElementById('pdf-viewer');
        const scrollContainer = document.getElementById('pdf-container');

        // Balanced scale for QR code scanning and performance
        const INITIAL_SCALE = 1.7; // Balanced between quality and performance
        
        const params = new URLSearchParams(window.location.search);
        let targetPageNum = parseInt(params.get('page'), 10) || 1;

        let pdfDoc = null;
        const renderedPages = new Set();
        const pageWrappers = [];
        const renderQueue = [];
        const preloadedPages = new Set();

        // More aggressive observer settings for better performance
        const observerOptions = {
            root: scrollContainer,
            rootMargin: '500px', // Increased from 300px
            threshold: 0.01
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const pageNum = parseInt(entry.target.dataset.pageNum);
                    if (!renderedPages.has(pageNum)) {
                        queuePageRender(pageNum);
                    }
                    // Preload adjacent pages
                    preloadAdjacentPages(pageNum);
                }
            });
        }, observerOptions);

        // Queue-based rendering to prevent blocking
        function queuePageRender(pageNum) {
            if (renderQueue.includes(pageNum)) return;
            renderQueue.push(pageNum);
            processRenderQueue();
        }

        async function processRenderQueue() {
            if (renderQueue.length === 0) return;
            
            const pageNum = renderQueue.shift();
            await renderPage(pageNum);
            
            // Continue processing queue with longer delay to prevent blocking
            if (renderQueue.length > 0) {
                setTimeout(processRenderQueue, 100);
            }
        }

        // Smart preloading of adjacent pages (reduced for better performance)
        function preloadAdjacentPages(currentPage) {
            const adjacentPages = [
                currentPage - 1,
                currentPage + 1
            ].filter(page => page > 0 && page <= totalPages && !preloadedPages.has(page));

            adjacentPages.forEach(pageNum => {
                preloadedPages.add(pageNum);
                setTimeout(() => queuePageRender(pageNum), 500);
            });
        }

        async function renderPage(pageNum) {
            if (renderedPages.has(pageNum) || !pdfDoc) return;
            
            renderedPages.add(pageNum);
            
            try {
                const page = await pdfDoc.getPage(pageNum);
                const wrapper = pageWrappers[pageNum - 1];
                
                if (!wrapper) return;
                
                // Use higher scale for better QR code quality
                const scale = INITIAL_SCALE;
                const viewport = page.getViewport({ scale });
                
                wrapper.innerHTML = '';
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { 
                    alpha: false,
                    willReadFrequently: false,
                    desynchronized: true // Performance optimization
                });
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                wrapper.appendChild(canvas);
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport,
                    intent: 'display',
                    enableWebGL: true // Hardware acceleration if available
                };
                
                await page.render(renderContext).promise;
                
                pagesLoaded++;
                updateProgress(renderedPages.size, totalPages, `Rendered ${renderedPages.size}/${totalPages} pages`);
                
                console.log(`Page ${pageNum} rendered at scale ${scale}`);
                
            } catch (err) {
                console.error('Error rendering page', pageNum, err);
            }
        }

        // Initialize PDF loading with progress tracking
        updateProgress(0, 100, 'Connecting to server...');

        const loadingTask = pdfjsLib.getDocument({
            url: url,
            cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
            cMapPacked: true,
            standardFontDataUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/standard_fonts/',
            useSystemFonts: false,
            disableAutoFetch: false,
            disableStream: false
        });

        // Track PDF loading progress
        loadingTask.onProgress = function(progress) {
            if (progress.total > 0) {
                const percentage = (progress.loaded / progress.total) * 50; // First 50% for download
                updateProgress(percentage, 100, `Downloading PDF... ${Math.round(percentage)}%`);
            }
        };
        
        loadingTask.promise.then(pdf => {
            pdfDoc = pdf;
            totalPages = pdf.numPages;
            
            updateProgress(50, 100, 'PDF loaded, preparing pages...');
            updatePerformance('PDF loaded successfully');
            
            if (targetPageNum > totalPages) targetPageNum = totalPages;

            // Create page wrappers
            for (let i = 1; i <= totalPages; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'page-wrapper';
                wrapper.dataset.pageNum = i;
                wrapper.innerHTML = '<div class="loading-placeholder">Loading page ' + i + '...</div>';
                container.appendChild(wrapper);
                pageWrappers.push(wrapper);
                observer.observe(wrapper);
            }

            updateProgress(75, 100, 'Initializing viewer...');

            // Priority rendering: target page first, then adjacent pages
            const priorityPages = [
                targetPageNum,
                Math.max(1, targetPageNum - 1),
                Math.min(totalPages, targetPageNum + 1)
            ];

            // Render priority pages immediately
            Promise.all(priorityPages.map(pageNum => renderPage(pageNum)))
                .then(() => {
                    updateProgress(100, 100, 'Ready!');
                    hideLoadingOverlay();
                    updatePerformance('Initial pages rendered');

                    // Scroll to target page
                    setTimeout(() => {
                        pageWrappers[targetPageNum - 1].scrollIntoView({ 
                            behavior: 'auto', 
                            block: 'start' 
                        });
                    }, 100);

                    // Hide zoom hint after 7 seconds
                    setTimeout(() => {
                        const zoomHint = document.querySelector('.zoom-hint');
                        if (zoomHint) zoomHint.style.display = 'none';
                    }, 7000);

                    // Background rendering disabled for better responsiveness
                    // Pages will render on-demand when scrolled into view
                });

        }).catch(err => {
            console.error('Error loading PDF:', err);
            loadingStatus.textContent = 'Error loading PDF';
            updatePerformance('Failed to load PDF');
            setTimeout(() => {
                container.innerHTML = '<p style="color: white; text-align: center; padding: 2rem;">Error loading PDF. Please refresh the page.</p>';
                hideLoadingOverlay();
            }, 2000);
        });

        // Native browser zoom works better for QR codes without interfering with scrolling
        // Users can use pinch-to-zoom naturally or Ctrl+scroll wheel
        
        // Prevent accidental zoom reset
        container.addEventListener('dblclick', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
